<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <title>إنشاء طالب والتحقق من الحجز</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS (via CDN or local) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark py-2" dir="rtl">
        <div class="container d-flex flex-column flex-lg-row align-items-center justify-content-between">
            <!-- Right on large screens, top on mobile -->
            <span class="navbar-text fs-5 fw-bold">
                رئاسة جامعة كركوك - مركز الحاسبة
            </span>

            <!-- Left on large screens, bottom on mobile -->
            <a class="navbar-brand fw-bold fs-4" href="/">
                تطبيق الحجز
            </a>
        </div>
    </nav>



    <div class="container py-4">
        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card shadow-sm">
                    <div class="card-header fw-bold">قدم على الحجز</div>
                    <div class="card-body">
                        <% if (flash) { %>
                            <div class="alert alert-<%= flash.type %>">
                                <%= flash.msg %>
                            </div>
                            <% } %>

                                <form action="/students" method="POST" class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">الاسم</label>
                                        <input required name="name" type="text" class="form-control"
                                            placeholder="الاسم الكامل">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">رقم الهاتف</label>
                                        <input required name="phone_number" type="text" class="form-control"
                                            placeholder="مثال: 07xxxxxxxx">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label"> رقم الهويةاو بطاقة الموحدة</label>
                                        <input required name="id_number" type="text" class="form-control"
                                            placeholder="الهوية الوطنية">
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">التاريخ</label>
                                        <!-- <input id="date" name="date" type="date" class="form-control" required> -->
                                        <input id="date" name="date" type="text" class="form-control" required>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">المركز</label>
                                        <select id="center" name="center_id" class="form-select" required>
                                            <option value="">-- اختر المركز --</option>
                                            <% centers.forEach(c=> { %>
                                                <option value="<%= c.id %>">
                                                    <%= c.name %>
                                                </option>
                                                <% }); %>
                                        </select>
                                    </div>

                                    <div class="col-12">
                                        <button id="createBookingBtn" type="submit" class="btn btn-primary">إنشاء
                                            الحجز</button>
                                    </div>
                                </form>

                    </div>
                </div>
            </div>

            <!-- Reservation status panel -->
            <div class="card-body">
                <!-- Spinner (hidden by default) -->
                <div id="resvSpinner" class="d-none text-center my-3">
                    <div class="spinner-border" role="status" aria-hidden="true"></div>
                    <div class="small text-muted mt-2">جاري تحميل الحجز...</div>
                </div>

                <div id="resvInfo" class="d-none">
                    <div id="resvAlert" class="alert" role="alert"></div>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>التاريخ</span> <strong id="resvDate">—</strong>
                        </li>
                        <!-- <li class="list-group-item d-flex justify-content-between">
                            <span>الكلية</span> <strong id="resvCollege">—</strong>
                        </li> -->
                        <li class="list-group-item d-flex justify-content-between">
                            <span>المركز</span> <strong id="resvCenter">—</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>السعة</span> <strong id="resvCapacity">—</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>المحجوز</span> <strong id="resvReserved">—</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>المتاحة</span> <strong id="resvAvailable">—</strong>
                        </li>
                    </ul>
                </div>

                <div id="resvPlaceholder" class="text-muted">
                    اختر <em>التاريخ</em> و <em>المركز</em> للتحقق من الحجز أو إنشائه.
                </div>
            </div>




            <!-- Bootstrap JS (optional) -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
            <script>
                flatpickr("#date", {
                    dateFormat: "Y-m-d",
                    disable: [
                        function (date) {
                            // Disable Fridays (5) and Saturdays (6)
                            return (date.getDay() === 5 || date.getDay() === 6);
                        }
                    ],
                    defaultDate: "today", // pre-select today
                });
            </script>

            <!-- Inline script to auto-check/create reservation -->
            <script>
                const createBookingBtn = document.getElementById('createBookingBtn');

                const dateEl = document.getElementById('date');

                const centerEl = document.getElementById('center');

                const infoBox = document.getElementById('resvInfo');
                const placeholder = document.getElementById('resvPlaceholder');
                const spinner = document.getElementById('resvSpinner');
                const alertBox = document.getElementById('resvAlert');

                const resvDate = document.getElementById('resvDate');
                const resvCenter = document.getElementById('resvCenter');
                const resvCapacity = document.getElementById('resvCapacity');
                const resvReserved = document.getElementById('resvReserved');
                const resvAvailable = document.getElementById('resvAvailable');

                let debounceTimer;

                function setLoading(isLoading) {
                    if (isLoading) {
                        spinner.classList.remove('d-none');
                        infoBox.classList.add('d-none');
                        // keep placeholder state as-is; we’ll hide it after success
                    } else {
                        spinner.classList.add('d-none');
                    }
                }

                [dateEl, centerEl].forEach(el => {
                    el.addEventListener('change', () => {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(checkReservation, 200);
                    });
                });

                async function checkReservation() {
                    const date = dateEl.value;
                    const center_id = centerEl.value;

                    if (!date || !center_id) {
                        infoBox.classList.add('d-none');
                        spinner.classList.add('d-none');
                        placeholder.classList.remove('d-none');
                        return;
                    }

                    setLoading(true);

                    try {
                        const params = new URLSearchParams({ date, center_id });
                        const resp = await fetch(`/students/api/reservations/check?${params.toString()}`);
                        const data = await resp.json();
                        console.log(data)

                        setLoading(false);

                        if (!data.ok) {
                            alertBox.className = 'alert alert-danger';
                            alertBox.textContent = data.error || 'فشل في التحقق من الحجز.';
                            infoBox.classList.remove('d-none');
                            placeholder.classList.add('d-none');
                            resvDate.textContent = '—';
                            resvCenter.textContent = '—';
                            resvCapacity.textContent = '—';
                            resvReserved.textContent = '—';
                            resvAvailable.textContent = '—';
                            return;
                        }

                        // Success: show stats with names
                        alertBox.className = 'alert alert-info';
                        if (data.reservation.available) {
                            alertBox.textContent = 'تم العثور على الحجز (أو تم إنشاؤه) للتاريخ والمركز المحدد.';
                            createBookingBtn.disabled = false;
                        } else {
                            alertBox.textContent = 'كل المقاعد محجوز لهذا التاريخ اختر تاريخا اخر';
                            createBookingBtn.disabled = true;
                            alertBox.className = 'alert alert-danger';
                        }

                        resvDate.textContent = data.reservation.date;
                        resvCenter.textContent = data.reservation.center_name || `#${data.reservation.center_id}`;
                        resvCapacity.textContent = data.reservation.capacity;
                        resvReserved.textContent = data.reservation.reserved;
                        resvAvailable.textContent = data.reservation.available;

                        infoBox.classList.remove('d-none');
                        placeholder.classList.add('d-none');
                    } catch (e) {
                        setLoading(false);
                        alertBox.className = 'alert alert-danger';
                        alertBox.textContent = e.message || 'خطأ في الشبكة أثناء التحقق من الحجز.';
                        infoBox.classList.remove('d-none');
                        placeholder.classList.add('d-none');
                    }
                }
            </script>

</body>

</html>